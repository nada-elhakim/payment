<!doctype html>
<html>
  <head>
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/main.css" />
    <script src="https://cdn.jsdelivr.net/npm/paymob-pixel@latest/main.js" type="module"></script>
    <style>
      html, body {
        font: 14px "Lucida Grande", Helvetica, Arial, sans-serif;
        height: 100%;
        overflow: auto;
        background-color: #fdfdf6;
      }
      #paymob {
        background-color: #fdfdf6;
        padding: 16px;
      }
      #payFromOutsideButton {
        padding: 16px;
        background: #2b772b;
        color: white;
        border-radius: 25px;
        height: 50px;
        width: calc(100% - 32px);
        display: block;
        margin: auto;
      }
      #payFromOutsideButton:hover, #payFromOutsideButton:focus {
        background-color: #0e3b0e;
      }
      #paymob img[class*="copyrights_logo"], #paymob img[alt="paymob"] {
        display: none !important;
      }
    </style>
    <script>
      window.clientSecret = '${clientSecret.replace(/'/g, "\\'")}';
      window.publicKey = '${publicKey.replace(/'/g, "\\'")}';
      window.language = '${lang.replace(/'/g, "\\'")}';
      window.paymentFlowType = '${flowType.replace(/'/g, "\\'")}';
    </script>
  </head>
  <body>
    <div id="container">
      <div id="content">
        <div id="paymob"></div>
        <button id="payFromOutsideButton"><p id="payText"></p></button>
      </div>
    </div>
    <script>
      function getConfigValue(key, defaultValue = null) {
        if (typeof window[key] !== "undefined") return window[key];
        const cookies = document.cookie.split(";").reduce((acc, cookie) => {
          const [k, v] = cookie.trim().split("=");
          if (k && v) acc[k] = decodeURIComponent(v);
          return acc;
        }, {});
        if (cookies[key]) return cookies[key];
        const params = new URLSearchParams(window.location.search);
        return params.get(key) || defaultValue;
      }

      window.onload = function () {
        const payButton = document.getElementById("payFromOutsideButton");
        const payText = document.getElementById("payText");
        const paymentFlowType = getConfigValue("paymentFlowType", "Pay");
        const language = getConfigValue("language", "en");
        const publicKey = getConfigValue("publicKey");
        const secretKey = getConfigValue("clientSecret");

        if (!publicKey || !secretKey) {
          console.error("Missing required configuration: publicKey or clientSecret");
          return;
        }

        if (paymentFlowType === "SaveCard") {
          payText.innerText = language === "en" ? "Save card" : "Ø­ÙØ¸";
        } else {
          payText.innerText = language === "en" ? "Pay" : "Ø¯ÙØ¹";
        }

        payButton.disabled = true;
        payButton.style.opacity = "0.6";
        payButton.style.cursor = "not-allowed";

        new Pixel({
          publicKey,
          clientSecret: secretKey,
          paymentMethods: ["card"],
          elementId: "paymob",
          disablePay: true,
          forceSaveCard: paymentFlowType === "SaveCard",
          showSaveCard: paymentFlowType !== "SaveCard",
          afterPaymentComplete: async (response) => {
            console.log("ðŸ’³ Payment complete", response);
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(JSON.stringify({ afterPaymentComplete: response }));
            }
          },
          cardValidationChanged: (isValid) => {
            payButton.disabled = !isValid;
            payButton.style.opacity = isValid ? "1" : "0.6";
            payButton.style.cursor = isValid ? "pointer" : "not-allowed";
          },
          customStyle: {
            Font_Family: 'Gotham',
            Font_Size_Label: '16',
            Font_Size_Input_Fields: '16',
            Font_Size_Payment_Button: '14',
            Font_Weight_Label: 400,
            Font_Weight_Input_Fields: 200,
            Font_Weight_Payment_Button: 600,
            Color_Container: '#FDFDF6',
            Color_Border_Input_Fields: '#D0D5DD',
            Color_Border_Payment_Button: '#A1B8FF',
            Radius_Border: '8',
            Color_Disabled: '#A1B8FF',
            Color_Error: '#CC1142',
            Color_Primary: '#2B772B',
            Color_Input_Fields: '#FFF',
            Text_Color_For_Label: '#000',
            Text_Color_For_Payment_Button: '#FFF',
            Text_Color_For_Input_Fields: '#000',
            Color_For_Text_Placeholder: '#667085',
            Width_of_Container: '100%',
            Vertical_Padding: '40',
            ...(language === "ar" && {
              Direction: 'rtl',
              Label_Text: {
                cardLabel: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                savedCardsLabel: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ·Ø©',
                saveCardConsentLabel: 'Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                cardEndingLabel: 'ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€',
              },
              Placeholder_Text: {
                holderName: 'Ø§Ù„Ø§Ø³Ù… Ø¹Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                cardNumber: 'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                expiryDate: 'Ø³Ù†Ø© / Ø´Ù‡Ø±',
                securityCode: '(CVV) Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø§Ù…Ù†ÙŠ',
              },
              Error_Text: {
                holderName: 'Ù…Ø·Ù„ÙˆØ¨ Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                cardNumber: {
                  required: 'Ù…Ø·Ù„ÙˆØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
                  invalid: 'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­',
                },
                expiryDate: {
                  required: 'Ù…Ø·Ù„ÙˆØ¨ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©',
                  invalid: 'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­',
                },
              },
              Button_Text: {
                viewSavedCardsBtn: 'Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',
                addNewCardBtn: 'Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                payBtn: 'Ø§Ø¯ÙØ¹',
              },
              Hint_Text: {
                saveCardConsentHint:
                  'Ø³ÙŠØªÙ… Ø­ÙØ¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.',
                cvvModalTitle: 'Ø±Ù…Ø² CVV',
                cvvVisaMastercardQuestion: 'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯ Ø£Ùˆ ÙÙŠØ²Ø§ØŸ',
                cvvVisaMastercardHint:
                  'Ù‡Ùˆ Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 3 Ø£Ø±Ù‚Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.',
                cvvAmexQuestion: 'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø¨Ø·Ø§Ù‚Ø© Ø£Ù…Ø±ÙŠÙƒØ§Ù† Ø¥ÙƒØ³Ø¨Ø±ÙŠØ³ØŸ',
                cvvAmexHint:
                  'Ù‡Ùˆ Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙÙˆÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.',
              },
            }),
          },
        });

        payButton.addEventListener("click", function () {
          const event = new Event("payFromOutside");
          window.dispatchEvent(event);
          payText.innerText = language === "ar" ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„" : "Loading...";
        });

        let count = 0;
        const interval = setInterval(() => {
          const host = document.querySelector("#paymob div");
          count++;
          if (host && host.shadowRoot) {
            const images = host.shadowRoot.querySelectorAll("img[class*='copyrights_logo']");
            if (images.length > 0) {
              images.forEach((img) => img.parentElement?.remove());
            }
          }
          if (count >= 100) clearInterval(interval);
        }, 100);
      };
    </script>
  </body>
</html>
